…¨DateTime×ÿÀšfÑ–ªThreadNameÀ°CopilotSessionId‚¤GuidÙ$336c22dd-32bb-40e9-b3f7-9c9171323dae¨ClientId¢IdÙ4Microsoft.VisualStudio.Conversations.Chat.HelpWindow§Request§Request•Ù$54ea4e34-939f-4744-aef2-b349ad1d95d9Ù$01608664-0685-424a-b04c-a981aaa2627d‘†¯ProviderMoniker‚¤NameÙ6Microsoft.VisualStudio.Copilot.DocumentContextProvider§Version£0.1¦Member¤file©CanReduceÃ©RequestIdÙ$54ea4e34-939f-4744-aef2-b349ad1d95d9©ReferenceÀ¥ValueÈ9—dÙ‘Microsoft.VisualStudio.Copilot.DocumentContext, Microsoft.VisualStudio.Copilot, Version=0.2.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a…§ContentÚ8eusing System;
using System.Collections;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Net;
using System.Net.Sockets;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;


namespace TCP_Helper.Forms.Setting
{
	public partial class Form_Setting : Form
	{
		public string LAN_Mode = string.Empty;  //é€šä¿¡æ–¹å¼
		public Func<int> GetEncoding; //è·å–ç¼–ç æ ¼å¼
		
		public bool IsOpen = false; //å±€åŸŸç½‘æ˜¯å¦å·²ç»å¼€å¯
		public bool Running { get; set; } //æ˜¯å¦æ­£åœ¨è¿è¡Œ åªèƒ½å†…éƒ¨è®¾ç½®ï¼Œä¾›å¤–éƒ¨è¯»å–æ ‡å¿—ä½
		/// <summary>
		/// å‘é€å­—èŠ‚æ•°
		/// </summary>
		private int SendBytes { get; set; }
		/// <summary>
		/// æ¥æ”¶å­—èŠ‚é€Ÿç‡
		/// </summary>
		private int RecByteSpeed { get; set; }
		private int RecByteTemp { get; set; }
		/// <summary>
		/// æ¥æ”¶æ•°æ®å›è°ƒ
		/// </summary>
		public event Action<byte[]> DataReceived;
		/// <summary>
		/// æ•°æ®å¤„ç†
		/// </summary>
		public event Action<List<object>> DataHandler;
		/// <summary>
		/// å‘é€é˜Ÿåˆ—
		/// </summary>
		private readonly DataBuffer SendBuffer = new DataBuffer();
		/// <summary>
		/// ä¸´æ—¶å®¢æˆ·ç«¯ä¿¡æ¯
		/// </summary>
		private Hashtable clientTable = new Hashtable(30);
		public Form_Setting()
		{
			InitializeComponent();
			Running = false;
			TXComboBox.Items.Add("TCP Server");
			TXComboBox.Items.Add("TCP Client");
			TXComboBox.Items.Add("UDP");
		}
		#region comboBoxè¿œç¨‹ç«¯ç‚¹æ›´æ”¹
		private void ComboBox_RemoteIP_Add(EndPoint ep)
		{
			if (RemoteIPComboBox.InvokeRequired)
			{
				Action<EndPoint> action = ComboBox_RemoteIP_Add;
				RemoteIPComboBox.Invoke(action, ep);
			}
			else
			{
				RemoteIPComboBox.Items.Add(ep);
			}
		}

		private void ComboBox_RemoteIP_Delete(EndPoint ep)
		{
			if (RemoteIPComboBox.InvokeRequired)
			{
				Action<EndPoint> action = ComboBox_RemoteIP_Delete;
				RemoteIPComboBox.Invoke(action, ep);
			}
			else
			{
				if (RemoteIPComboBox.Items.Contains(ep))
					RemoteIPComboBox.Items.Remove(ep);
				if (RemoteIPComboBox.Text == ep.ToString())
					RemoteIPComboBox.Text = "";
			}
		}
		#endregion

		#region å¼€å¯å®šæ—¶å™¨ æ¥æ”¶é€Ÿç‡æ›´æ–°
		private void RecSpeedTimerStart()
		{
			System.Threading.Timer timer_1s = null;
			timer_1s = new System.Threading.Timer(timer =>
			{
				if (IsOpen)
				{
					RecByteSpeed = RecByteTemp;
					RecByteTemp = 0;
				}
				else
				{
					timer_1s.Dispose();
				}
			}, timer_1s, 0, 1000);
		}


		#endregion

		#region TCP UDP é€šä¿¡
		private void BtnConnect_Click(object sender, EventArgs e)
		{
			if (BtnConnect.Text == "æ–­å¼€è¿æ¥")
			{
				IsOpen = false;
			}
			else if (BtnConnect.Text == "æ‰“å¼€è¿æ¥")
			{
				if (TXComboBox.Text == "TCP Server")
				{
					TCPServerOpen();
				}
				else if (TXComboBox.Text == "TCP Client")
				{
					TCPClientConnect();
				}
				else if (TXComboBox.Text == "UDP")
				{
					UDPClientConnect();
				}
			}
		}

		#region TCP Server
		private Socket TCPServer;
		public void TCPServerOpen()
		{
			int Port = 0;
			try
			{
				Port = int.Parse(PortBox.Text);
			}
			catch (Exception ex)
			{
				MessageBox.Show(ex.Message, "Portè¾“å…¥é”™è¯¯");
				return;
			}
			BtnConnect.Text = "è¿æ¥ä¸­";
			Task task = Task.Run(() =>
			{
				try
				{
					//åˆå§‹åŒ–SOCKETå®ä¾‹
					TCPServer = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);
					//å…è®¸SOCKETè¢«ç»‘å®šåœ¨å·²ä½¿ç”¨çš„åœ°å€ä¸Šã€‚
					TCPServer.SetSocketOption(SocketOptionLevel.Socket, SocketOptionName.ReuseAddress, true);
					//ç»‘å®šåˆ°æŒ‡å®šIPï¼ŒPortå£ä¸Š
					string LocalAddress = ThisIPComboBox.Text;
					TCPServer.Bind(new IPEndPoint(LocalAddress == "Any" ? IPAddress.Any : IPAddress.Parse(LocalAddress), Port));
					//ç›‘å¬
					TCPServer.Listen(30);
					//å¼€å§‹æ¥å—è¿æ¥ï¼Œå¼‚æ­¥ã€‚
					TCPServer.BeginAccept(new AsyncCallback(OnConnectRequest), TCPServer);
					//æœåŠ¡å™¨å·²å¼€å¯
					BtnConnect.Text = "æ–­å¼€è¿æ¥";
					IsOpen = true;
					Running = true;

					//å¼€å¯1så®šæ—¶å™¨ æ›´æ–°æ¥æ”¶é€Ÿç‡
					RecSpeedTimerStart();

					//å¼€å¯æ•°æ®å¤„ç†çº¿ç¨‹
					Task DataHandlerTask = Task.Run(() =>
					{
						while (IsOpen)
						{
							DataHandler?.Invoke(new List<object>
							{
								GetEncoding.Invoke(),
								RecByteSpeed,
								SendBytes,
								(float)0.0F, //æ— ä¸Šé™
                            });
							System.Threading.Thread.Sleep(50); //20fps
						}
					});

					int SleepTime = 1;
					while (IsOpen)
					{
						if (SendBuffer.DataLenth() > 0 && RemoteIPComboBox.Items.Count > 0)
						{
							byte[] data = SendBuffer.GetDeleteData(-1);
							if (RemoteIPComboBox.SelectedItem != null)
							{
								TCP_Server_Send(data, (EndPoint)RemoteIPComboBox.SelectedItem);
							}
							else
							{
								for (int i = 0; i < RemoteIPComboBox.Items.Count; i++)
								{
									if (i < RemoteIPComboBox.Items.Count)
									{
										EndPoint ep = (EndPoint)RemoteIPComboBox.Items[i];
										TCP_Server_Send(data, (EndPoint)ep);
									}
								}
							}
							SendBytes += data.Length;
							SleepTime = 1;
						}
						else
						{
							System.Threading.Thread.Sleep(SleepTime); //èŠ‚çœCPUèµ„æº
							SleepTime = SleepTime == 100 ? SleepTime : SleepTime++;
						}
					}
				}
				catch (Exception ex)
				{
					MessageBox.Show(ex.Message, "å¼€å¯æœåŠ¡å™¨å¤±è´¥");
				}
				IsOpen = false;
				TCPServer.Close();
				TCPServer.Dispose();
				BtnConnect.Text = "æ‰“å¼€è¿æ¥";
				Running = false;
			});
		}

		private void OnConnectRequest(IAsyncResult ar)
		{
			try
			{
				if (!IsOpen) return;
				///åˆå§‹åŒ–ä¸€ä¸ªSOCKETï¼Œç”¨äºå…¶å®ƒå®¢æˆ·ç«¯çš„è¿æ¥
				Socket client = TCPServer.EndAccept(ar);
				EndPoint remote = client.RemoteEndPoint;
				///è®¾ç½®è¶…æ—¶æ—¶é—´2s
				client.ReceiveTimeout = 2000;
				///å°†å®¢æˆ·ç«¯ç‚¹æ·»åŠ åˆ°å“ˆå¸Œè¡¨ä¸­
				clientTable.Add(remote, client);
				///æ·»åŠ åˆ°comboxç»„ä»¶
				ComboBox_RemoteIP_Add(remote);
				///ç­‰å¾…æ–°çš„å®¢æˆ·ç«¯è¿æ¥
				TCPServer.BeginAccept(new AsyncCallback(OnConnectRequest), TCPServer);

				
				///æœåŠ¡å™¨æœªå…³é—­
				///è¿æ¥æ­£å¸¸
				while (IsOpen && !(client.Poll(1000, SelectMode.SelectRead) && client.Available == 0))
				{
					try
					{
						byte[] newdata = new byte[1024];
						int lenth = client.Receive(newdata);
						DataReceived.Invoke(newdata.Take(lenth).ToArray());
						RecByteTemp += lenth;
					}
					catch { }
				}
				clientTable.Remove(remote);
				ComboBox_RemoteIP_Delete(remote);
				client.Close();
				client.Dispose();
			}
			catch (SocketException ex)
			{
				MessageBox.Show(ex.Message, "å®¢æˆ·ç«¯å¼‚å¸¸");
				//é‡æ–°å¼€å§‹å¼‚æ­¥è¿æ¥
				//TCPServer.BeginAccept(new AsyncCallback(OnConnectRequest), TCPServer);
			}
		}

		/// <summary>
		/// å‘é€
		/// </summary>
		private void TCP_Server_Send(byte[] data, EndPoint ep)
		{
			try
			{
				if (ep != null && clientTable.ContainsKey(ep))
				{
					Socket socket = (Socket)clientTable[ep];
					socket.SendTo(data, ep);
				}
			}
			catch { }
		}
		#endregion

		#region TCP Client

		Socket TCPClient;
		private void TCPClientConnect()
		{
			int Port = 0;
			try
			{
				Port = int.Parse(PortBox.Text);
			}
			catch (Exception ex)
			{
				MessageBox.Show(ex.Message, "Portè¾“å…¥é”™è¯¯");
				return;
			}

			IPAddress address;
			try
			{
				address = IPAddress.Parse(RemoteIPComboBox.Text);
			}
			catch (Exception ex)
			{
				MessageBox.Show(ex.Message, "RemoteAddressè¾“å…¥é”™è¯¯");
				return;
			}

			BtnConnect.Text = "è¿æ¥ä¸­";
			Task connect = Task.Run(() =>
			{
				TCPClient = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);
				try
				{
					TCPClient.Connect(new IPEndPoint(address, Port));
					BtnConnect.Text = "æ–­å¼€è¿æ¥";
					IsOpen = true;
					Running = true;
					//å¼€å¯1så®šæ—¶å™¨ æ›´æ–°æ¥æ”¶é€Ÿç‡
					RecSpeedTimerStart();
					//å¼€å¯æ•°æ®å¤„ç†çº¿ç¨‹
					Task DataHandlerTask = Task.Run(() =>
					{
						while (IsOpen)
						{
							DataHandler?.Invoke(new List<object>
							{
								GetEncoding.Invoke(),
								RecByteSpeed,
								SendBytes,
								(float)0.0F, //æ— ä¸Šé™
                            });
							System.Threading.Thread.Sleep(50); //20fps
						}
					});
					//å¼€å¯å‘é€çº¿ç¨‹
					Task SendTask = Task.Run(() =>
					{
						int SleepTime = 1;
						while (IsOpen)
						{
							try
							{
								if (SendBuffer.DataLenth() > 0)
								{
									byte[] data = SendBuffer.GetDeleteData(-1);
									TCPClient.Send(data);
									SendBytes += data.Length;
									SleepTime = 1;
								}
								else
								{
									System.Threading.Thread.Sleep(SleepTime); //èŠ‚çœCPUèµ„æº
									SleepTime = SleepTime == 100 ? SleepTime : SleepTime++;
								}
							}
							catch { IsOpen = false; }
						}
					});

					TCP_ClientListenning();
				}
				catch (SocketException ex)
				{
					//System.Threading.Thread.Sleep(1000); //1såé‡æ–°è®¿é—®
					//TCPServerConnect();  //ä¸€ç›´è®¿é—®ç›´è‡³è¿æ¥
					MessageBox.Show(ex.Message, "è¿æ¥æœåŠ¡å™¨å¤±è´¥");
				}
				IsOpen = false;
				TCPClient.Dispose();
				BtnConnect.Text = "æ‰“å¼€è¿æ¥";
				Running = false;
			});
		}

		private void TCP_ClientListenning()
		{
			TCPClient.ReceiveTimeout = 2000; //è®¾ç½®è¶…æ—¶æ—¶é—´2s

			///å®¢æˆ·ç«¯æ‰“å¼€
			///è¿æ¥æ­£å¸¸
			while (IsOpen && !(TCPClient.Poll(1000, SelectMode.SelectRead) && TCPClient.Available == 0))
			{
				try
				{
					byte[] newdata = new byte[1024];
					int lenth = TCPClient.Receive(newdata, 1024, SocketFlags.None);
					DataReceived.Invoke(newdata.Take(lenth).ToArray());
					RecByteTemp += lenth;
				}
				catch { }
			}
			if (IsOpen) MessageBox.Show(string.Format("ä¸æœåŠ¡å™¨ {0} çš„è¿æ¥å·²æ–­å¼€", TCPClient.RemoteEndPoint), "è¿æ¥æœåŠ¡å™¨å¼‚å¸¸");
		}

		#endregion

		#region UDP

		private void UDPClientConnect()
		{
			int Port = 0;
			try
			{
				Port = int.Parse(PortBox.Text);
			}
			catch (Exception ex)
			{
				MessageBox.Show(ex.Message, "Portè¾“å…¥é”™è¯¯");
				return;
			}

			IPAddress address;
			try
			{
				address = IPAddress.Parse(RemoteIPComboBox.Text);
			}
			catch (Exception ex)
			{
				MessageBox.Show(ex.Message, "RemoteAddressè¾“å…¥é”™è¯¯");
				return;
			}

			BtnConnect.Text = "è¿æ¥ä¸­";
			Task task = Task.Run(() =>
			{
				try
				{
					UdpClient udpClient = new UdpClient(Port);
					BtnConnect.Text = "æ–­å¼€è¿æ¥";
					IsOpen = true;
					Running = true;
					//å¼€å¯1så®šæ—¶å™¨ æ›´æ–°æ¥æ”¶é€Ÿç‡
					RecSpeedTimerStart();
					//å¼€å¯æ¥æ”¶çº¿ç¨‹
					Task RecTask = Task.Run(() =>
					{
						while (IsOpen)
						{
							try
							{
								IPEndPoint ep = new IPEndPoint(IPAddress.Any, 0);
								byte[] newdata = udpClient.Receive(ref ep);
								DataReceived.Invoke(newdata);
								RecByteTemp += newdata.Length;
							}
							catch { }
						}
					});

					//å¼€å¯æ•°æ®å¤„ç†çº¿ç¨‹
					Task DataHandlerTask = Task.Run(() =>
					{
						while (IsOpen)
						{
							DataHandler?.Invoke(new List<object>
							{
								GetEncoding.Invoke(),
								RecByteSpeed,
								SendBytes,
								(float)0.0F, //æ— ä¸Šé™
                            });
							System.Threading.Thread.Sleep(50); //20fps
						}
					});

					int SleepTime = 1;
					//å‘é€å¾ªç¯
					while (IsOpen)
					{
						try
						{
							if (SendBuffer.DataLenth() > 0)
							{
								try
								{
									Port = int.Parse(PortBox.Text);
								}
								catch (Exception ex)
								{
									MessageBox.Show(ex.Message, "Portè¾“å…¥é”™è¯¯");
									continue;
								}
								byte[] data = SendBuffer.GetDeleteData(-1);
								udpClient.Send(data, data.Length, new IPEndPoint(address, Port));
								SendBytes += data.Length;
								SleepTime = 1;
							}
							else
							{
								System.Threading.Thread.Sleep(SleepTime); //èŠ‚çœCPUèµ„æº
								SleepTime = SleepTime == 100 ? SleepTime : SleepTime++;
							}
						}
						catch (Exception ex)
						{
							MessageBox.Show(ex.Message, "Udp Send");
						}
					}
					udpClient.Close();
				}
				catch (SocketException ex)
				{
					MessageBox.Show(ex.Message, "å¼€å¯UDPå¤±è´¥");
				}
				IsOpen = false;
				BtnConnect.Text = "æ‰“å¼€è¿æ¥";
				Running = false;
			});

		}
		#endregion

		#endregion

		#region å‘é€æ•°æ®æ·»åŠ 

		/// <summary>
		/// æ¸…é™¤å‘é€æ•°æ®ä¸ªæ•°è®°å½•
		/// </summary>
		public void ClearSendBytes()
		{
			SendBytes = 0;
		}

		/// <summary>
		/// æ·»åŠ æ•°æ®åˆ°å‘é€é˜Ÿåˆ—
		/// </summary>
		/// <param name="buff"></param>
		public bool AddSendBuffer(string buff)
		{
			if (IsOpen)
			{
				switch (GetEncoding.Invoke())
				{
					case 0:
						SendBuffer.AddendData(Encoding.ASCII.GetBytes(buff));
						break;
					case 1:
						SendBuffer.AddendData(Encoding.UTF8.GetBytes(buff));
						break;
					case 2:
						SendBuffer.AddendData(Encoding.Unicode.GetBytes(buff));
						break;
				}
				return true;
			}
			return false;
		}

		/// <summary>
		/// æ·»åŠ æ•°æ®åˆ°å‘é€é˜Ÿåˆ—
		/// </summary>
		/// <param name="buff"></param>
		public bool AddSendBuffer(byte[] buff)
		{
			if (IsOpen)
			{
				SendBuffer.AddendData(buff);
				return true;
			}
			return false;
		}

		#endregion

		private void ThisIPComboBox_DropDown(object sender, EventArgs e)
		{
			try
			{
				ComboBox box = sender as ComboBox;
				string text = box.Text;
				box.Items.Clear();
				box.Items.Add("Any");
				IPAddress[] IPs = Dns.GetHostEntry(Dns.GetHostName()).AddressList;
				foreach (IPAddress ip in IPs)
				{
					if (ip.AddressFamily.ToString().Equals("InterNetwork")) box.Items.Add(ip.ToString());
				}
				box.SelectedItem = text;
			}
			catch (SocketException ex)
			{
				MessageBox.Show(ex.Message);
			}
		}



	}
}
¯OriginalContentÀªSelections‘ƒ¥CaretÀ¥StartÍ2å£EndÍ4¯¨FilePathÙGD:\Storage\Repo\GPT\TCP_Helper\TCP_Helper\Forms\Setting\Form_Setting.cs¨Language¢C#‘’“¥Value ÚÇtry
			{
				ComboBox box = sender as ComboBox;
				string text = box.Text;
				box.Items.Clear();
				box.Items.Add("Any");
				IPAddress[] IPs = Dns.GetHostEntry(Dns.GetHostName()).AddressList;
				foreach (IPAddress ip in IPs)
				{
					if (ip.AddressFamily.ToString().Equals("InterNetwork")) box.Items.Add(ip.ToString());
				}
				box.SelectedItem = text;
			}
			catch (SocketException ex)
			{
				MessageBox.Show(ex.Message);
			}À¨Response…§ContentÚè¿™æ®µä»£ç çš„ä¸»è¦ç›®çš„æ˜¯å¡«å……ä¸€ä¸ªä¸‹æ‹‰åˆ—è¡¨ï¼ˆComboBoxï¼‰çš„é¡¹ç›®ï¼Œè¿™äº›é¡¹ç›®æ˜¯å½“å‰ä¸»æœºçš„æ‰€æœ‰IPv4åœ°å€ã€‚è¿™æ˜¯é€šè¿‡ä»¥ä¸‹æ­¥éª¤å®Œæˆçš„ï¼š

1. `ComboBox box = sender as ComboBox;`ï¼šè¿™è¡Œä»£ç å°†è§¦å‘æ­¤äº‹ä»¶çš„å¯¹è±¡ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹åº”è¯¥æ˜¯ä¸€ä¸ªComboBoxï¼‰è½¬æ¢ä¸ºComboBoxç±»å‹ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨å˜é‡`box`ä¸­ã€‚

2. `string text = box.Text;`ï¼šè¿™è¡Œä»£ç è·å–ComboBoxå½“å‰é€‰ä¸­çš„æ–‡æœ¬ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨å˜é‡`text`ä¸­ã€‚

3. `box.Items.Clear();`ï¼šè¿™è¡Œä»£ç æ¸…é™¤ComboBoxçš„æ‰€æœ‰é¡¹ç›®ã€‚

4. `box.Items.Add("Any");`ï¼šè¿™è¡Œä»£ç åœ¨ComboBoxä¸­æ·»åŠ ä¸€ä¸ªåä¸º"Any"çš„é¡¹ç›®ã€‚

5. `IPAddress[] IPs = Dns.GetHostEntry(Dns.GetHostName()).AddressList;`ï¼šè¿™è¡Œä»£ç è·å–å½“å‰ä¸»æœºçš„æ‰€æœ‰IPåœ°å€ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨`IPs`æ•°ç»„ä¸­ã€‚

6. `foreach (IPAddress ip in IPs) {...}`ï¼šè¿™ä¸ªå¾ªç¯éå†æ‰€æœ‰çš„IPåœ°å€ã€‚

   - `if (ip.AddressFamily.ToString().Equals("InterNetwork")) box.Items.Add(ip.ToString());`ï¼šå¦‚æœIPåœ°å€æ˜¯IPv4åœ°å€ï¼ˆAddressFamilyä¸ºInterNetworkï¼‰ï¼Œåˆ™å°†å…¶æ·»åŠ åˆ°ComboBoxä¸­ã€‚

7. `box.SelectedItem = text;`ï¼šè¿™è¡Œä»£ç å°†ComboBoxçš„é€‰ä¸­é¡¹ç›®è®¾ç½®ä¸ºä¹‹å‰ä¿å­˜çš„æ–‡æœ¬ã€‚

8. `catch (SocketException ex) {...}`ï¼šå¦‚æœåœ¨æ‰§è¡Œä¸Šè¿°æ“ä½œæ—¶å‘ç”ŸSocketExceptionå¼‚å¸¸ï¼Œå°†æ˜¾ç¤ºä¸€ä¸ªåŒ…å«å¼‚å¸¸æ¶ˆæ¯çš„æ¶ˆæ¯æ¡†ã€‚

è¿™æ®µä»£ç é€šå¸¸ç”¨äºç½‘ç»œåº”ç”¨ç¨‹åºï¼Œå…¶ä¸­éœ€è¦ç”¨æˆ·é€‰æ‹©ä¸€ä¸ªIPåœ°å€ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªTCPæœåŠ¡å™¨åº”ç”¨ç¨‹åºï¼Œä½ å¯èƒ½å¸Œæœ›ç”¨æˆ·é€‰æ‹©æœåŠ¡å™¨åº”è¯¥ç»‘å®šåˆ°çš„IPåœ°å€ã€‚¤Type ¦Status¯FollowUpPrompts’ÙAå¦‚ä½•ä¿®æ”¹ä»£ç ä»¥åªæ˜¾ç¤ºIPv6åœ°å€ï¼Œè€Œä¸æ˜¯IPv4åœ°å€ï¼ŸÙ<è¿™æ®µä»£ç æ˜¯å¦èƒ½åœ¨æ‰€æœ‰æ“ä½œç³»ç»Ÿä¸Šæ­£å¸¸å·¥ä½œï¼Ÿ³CodeVulnerabilities…¨DateTime×ÿÛŒˆğfÖşªThreadNameÀ°CopilotSessionId‚¤GuidÙ$336c22dd-32bb-40e9-b3f7-9c9171323dae¨ClientId¢IdÙ4Microsoft.VisualStudio.Conversations.Chat.HelpWindow§Request§Request•Ù$067b7173-827b-46de-be57-73185a335d23Ù$ac3f25dd-9590-44ba-b7b0-62a95c0e5ef3‘†¯ProviderMoniker‚¤NameÙ6Microsoft.VisualStudio.Copilot.DocumentContextProvider§Version£0.1¦Member¤file©CanReduceÃ©RequestIdÙ$067b7173-827b-46de-be57-73185a335d23©ReferenceÀ¥ValueÈ:(dÙ‘Microsoft.VisualStudio.Copilot.DocumentContext, Microsoft.VisualStudio.Copilot, Version=0.2.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a…§ContentÚ8öusing System;
using System.Collections;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Net;
using System.Net.Sockets;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using Sunny.UI;

namespace TCP_Helper.Forms.Setting
{
	public partial class Form_Setting : Form
	{
		public string LAN_Mode = string.Empty;  //é€šä¿¡æ–¹å¼
		public Func<int> GetEncoding; //è·å–ç¼–ç æ ¼å¼
		
		public bool IsOpen = false; //å±€åŸŸç½‘æ˜¯å¦å·²ç»å¼€å¯
		public bool Running { get; set; } //æ˜¯å¦æ­£åœ¨è¿è¡Œ åªèƒ½å†…éƒ¨è®¾ç½®ï¼Œä¾›å¤–éƒ¨è¯»å–æ ‡å¿—ä½
		/// <summary>
		/// å‘é€å­—èŠ‚æ•°
		/// </summary>
		private int SendBytes { get; set; }
		/// <summary>
		/// æ¥æ”¶å­—èŠ‚é€Ÿç‡
		/// </summary>
		private int RecByteSpeed { get; set; }
		private int RecByteTemp { get; set; }
		/// <summary>
		/// æ¥æ”¶æ•°æ®å›è°ƒ
		/// </summary>
		public event Action<byte[]> DataReceived;
		/// <summary>
		/// æ•°æ®å¤„ç†
		/// </summary>
		public event Action<List<object>> DataHandler;
		/// <summary>
		/// å‘é€é˜Ÿåˆ—
		/// </summary>
		private readonly DataBuffer SendBuffer = new DataBuffer();
		/// <summary>
		/// ä¸´æ—¶å®¢æˆ·ç«¯ä¿¡æ¯
		/// </summary>
		private Hashtable clientTable = new Hashtable(30);
		public Form_Setting()
		{
			InitializeComponent();
			Running = false;
			TXComboBox.Items.Add("TCP Server");
			TXComboBox.Items.Add("TCP Client");
			TXComboBox.Items.Add("UDP");
		}
		#region comboBoxè¿œç¨‹ç«¯ç‚¹æ›´æ”¹
		private void ComboBox_RemoteIP_Add(EndPoint ep)
		{
			if (RemoteIPComboBox.InvokeRequired)
			{
				Action<EndPoint> action = ComboBox_RemoteIP_Add;
				RemoteIPComboBox.Invoke(action, ep);
			}
			else
			{
				RemoteIPComboBox.Items.Add(ep);
			}
		}

		private void ComboBox_RemoteIP_Delete(EndPoint ep)
		{
			if (RemoteIPComboBox.InvokeRequired)
			{
				Action<EndPoint> action = ComboBox_RemoteIP_Delete;
				RemoteIPComboBox.Invoke(action, ep);
			}
			else
			{
				if (RemoteIPComboBox.Items.Contains(ep))
					RemoteIPComboBox.Items.Remove(ep);
				if (RemoteIPComboBox.Text == ep.ToString())
					RemoteIPComboBox.Text = "";
			}
		}
		#endregion

		#region å¼€å¯å®šæ—¶å™¨ æ¥æ”¶é€Ÿç‡æ›´æ–°
		private void RecSpeedTimerStart()
		{
			System.Threading.Timer timer_1s = null;
			timer_1s = new System.Threading.Timer(timer =>
			{
				if (IsOpen)
				{
					RecByteSpeed = RecByteTemp;
					RecByteTemp = 0;
				}
				else
				{
					timer_1s.Dispose();
				}
			}, timer_1s, 0, 1000);
		}


		#endregion

		#region TCP UDP é€šä¿¡
		private void BtnConnect_Click(object sender, EventArgs e)
		{
			if (BtnConnect.Text == "æ–­å¼€è¿æ¥")
			{
				IsOpen = false;
			}
			else if (BtnConnect.Text == "æ‰“å¼€è¿æ¥")
			{
				if (TXComboBox.Text == "TCP Server")
				{
					TCPServerOpen();
				}
				else if (TXComboBox.Text == "TCP Client")
				{
					TCPClientConnect();
				}
				else if (TXComboBox.Text == "UDP")
				{
					UDPClientConnect();
				}
			}
		}

		#region TCP Server
		private Socket TCPServer;
		public void TCPServerOpen()
		{
			int Port = 0;
			try
			{
				Port = int.Parse(PortBox.Text);
			}
			catch (Exception ex)
			{
				MessageBox.Show(ex.Message, "Portè¾“å…¥é”™è¯¯");
				return;
			}
			BtnConnect.Text = "è¿æ¥ä¸­";
			Task task = Task.Run(() =>
			{
				try
				{
					//åˆå§‹åŒ–SOCKETå®ä¾‹
					TCPServer = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);
					//å…è®¸SOCKETè¢«ç»‘å®šåœ¨å·²ä½¿ç”¨çš„åœ°å€ä¸Šã€‚
					TCPServer.SetSocketOption(SocketOptionLevel.Socket, SocketOptionName.ReuseAddress, true);
					//ç»‘å®šåˆ°æŒ‡å®šIPï¼ŒPortå£ä¸Š
					string LocalAddress = ThisIPComboBox.Text;
					TCPServer.Bind(new IPEndPoint(LocalAddress == "Any" ? IPAddress.Any : IPAddress.Parse(LocalAddress), Port));
					//ç›‘å¬
					TCPServer.Listen(30);
					//å¼€å§‹æ¥å—è¿æ¥ï¼Œå¼‚æ­¥ã€‚
					TCPServer.BeginAccept(new AsyncCallback(OnConnectRequest), TCPServer);
					//æœåŠ¡å™¨å·²å¼€å¯
					BtnConnect.Text = "æ–­å¼€è¿æ¥";
					IsOpen = true;
					Running = true;

					//å¼€å¯1så®šæ—¶å™¨ æ›´æ–°æ¥æ”¶é€Ÿç‡
					RecSpeedTimerStart();

					//å¼€å¯æ•°æ®å¤„ç†çº¿ç¨‹
					Task DataHandlerTask = Task.Run(() =>
					{
						while (IsOpen)
						{
							DataHandler?.Invoke(new List<object>
							{
								GetEncoding.Invoke(),
								RecByteSpeed,
								SendBytes,
								(float)0.0F, //æ— ä¸Šé™
                            });
							System.Threading.Thread.Sleep(50); //20fps
						}
					});

					int SleepTime = 1;
					while (IsOpen)
					{
						if (SendBuffer.DataLenth() > 0 && RemoteIPComboBox.Items.Count > 0)
						{
							byte[] data = SendBuffer.GetDeleteData(-1);
							if (RemoteIPComboBox.SelectedItem != null)
							{
								TCP_Server_Send(data, (EndPoint)RemoteIPComboBox.SelectedItem);
							}
							else
							{
								for (int i = 0; i < RemoteIPComboBox.Items.Count; i++)
								{
									if (i < RemoteIPComboBox.Items.Count)
									{
										EndPoint ep = (EndPoint)RemoteIPComboBox.Items[i];
										TCP_Server_Send(data, (EndPoint)ep);
									}
								}
							}
							SendBytes += data.Length;
							SleepTime = 1;
						}
						else
						{
							System.Threading.Thread.Sleep(SleepTime); //èŠ‚çœCPUèµ„æº
							SleepTime = SleepTime == 100 ? SleepTime : SleepTime++;
						}
					}
				}
				catch (Exception ex)
				{
					MessageBox.Show(ex.Message, "å¼€å¯æœåŠ¡å™¨å¤±è´¥");
				}
				IsOpen = false;
				TCPServer.Close();
				TCPServer.Dispose();
				BtnConnect.Text = "æ‰“å¼€è¿æ¥";
				Running = false;
			});
		}

		private void OnConnectRequest(IAsyncResult ar)
		{
			try
			{
				if (!IsOpen) return;
				///åˆå§‹åŒ–ä¸€ä¸ªSOCKETï¼Œç”¨äºå…¶å®ƒå®¢æˆ·ç«¯çš„è¿æ¥
				Socket client = TCPServer.EndAccept(ar);
				EndPoint remote = client.RemoteEndPoint;
				///è®¾ç½®è¶…æ—¶æ—¶é—´2s
				client.ReceiveTimeout = 2000;
				///å°†å®¢æˆ·ç«¯ç‚¹æ·»åŠ åˆ°å“ˆå¸Œè¡¨ä¸­
				clientTable.Add(remote, client);
				///æ·»åŠ åˆ°comboxç»„ä»¶
				ComboBox_RemoteIP_Add(remote);
				///ç­‰å¾…æ–°çš„å®¢æˆ·ç«¯è¿æ¥
				TCPServer.BeginAccept(new AsyncCallback(OnConnectRequest), TCPServer);

				
				///æœåŠ¡å™¨æœªå…³é—­
				///è¿æ¥æ­£å¸¸
				while (IsOpen && !(client.Poll(1000, SelectMode.SelectRead) && client.Available == 0))
				{
					try
					{
						byte[] newdata = new byte[1024];
						int lenth = client.Receive(newdata);
						DataReceived.Invoke(newdata.Take(lenth).ToArray());
						RecByteTemp += lenth;
					}
					catch { }
				}
				clientTable.Remove(remote);
				ComboBox_RemoteIP_Delete(remote);
				client.Close();
				client.Dispose();
			}
			catch (SocketException ex)
			{
				MessageBox.Show(ex.Message, "å®¢æˆ·ç«¯å¼‚å¸¸");
				//é‡æ–°å¼€å§‹å¼‚æ­¥è¿æ¥
				//TCPServer.BeginAccept(new AsyncCallback(OnConnectRequest), TCPServer);
			}
		}

		/// <summary>
		/// å‘é€
		/// </summary>
		private void TCP_Server_Send(byte[] data, EndPoint ep)
		{
			try
			{
				if (ep != null && clientTable.ContainsKey(ep))
				{
					Socket socket = (Socket)clientTable[ep];
					socket.SendTo(data, ep);
				}
			}
			catch { }
		}
		#endregion

		#region TCP Client

		Socket TCPClient;
		private void TCPClientConnect()
		{
			int Port = 0;
			try
			{
				Port = int.Parse(PortBox.Text);
			}
			catch (Exception ex)
			{
				MessageBox.Show(ex.Message, "Portè¾“å…¥é”™è¯¯");
				return;
			}

			IPAddress address;
			try
			{
				address = IPAddress.Parse(RemoteIPComboBox.Text);
			}
			catch (Exception ex)
			{
				MessageBox.Show(ex.Message, "RemoteAddressè¾“å…¥é”™è¯¯");
				return;
			}

			BtnConnect.Text = "è¿æ¥ä¸­";
			Task connect = Task.Run(() =>
			{
				TCPClient = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);
				try
				{
					TCPClient.Connect(new IPEndPoint(address, Port));
					BtnConnect.Text = "æ–­å¼€è¿æ¥";
					IsOpen = true;
					Running = true;
					//å¼€å¯1så®šæ—¶å™¨ æ›´æ–°æ¥æ”¶é€Ÿç‡
					RecSpeedTimerStart();
					//å¼€å¯æ•°æ®å¤„ç†çº¿ç¨‹
					Task DataHandlerTask = Task.Run(() =>
					{
						while (IsOpen)
						{
							DataHandler?.Invoke(new List<object>
							{
								GetEncoding.Invoke(),
								RecByteSpeed,
								SendBytes,
								(float)0.0F, //æ— ä¸Šé™
                            });
							System.Threading.Thread.Sleep(50); //20fps
						}
					});
					//å¼€å¯å‘é€çº¿ç¨‹
					Task SendTask = Task.Run(() =>
					{
						int SleepTime = 1;
						while (IsOpen)
						{
							try
							{
								if (SendBuffer.DataLenth() > 0)
								{
									byte[] data = SendBuffer.GetDeleteData(-1);
									TCPClient.Send(data);
									SendBytes += data.Length;
									SleepTime = 1;
								}
								else
								{
									System.Threading.Thread.Sleep(SleepTime); //èŠ‚çœCPUèµ„æº
									SleepTime = SleepTime == 100 ? SleepTime : SleepTime++;
								}
							}
							catch { IsOpen = false; }
						}
					});

					TCP_ClientListenning();
				}
				catch (SocketException ex)
				{
					//System.Threading.Thread.Sleep(1000); //1såé‡æ–°è®¿é—®
					//TCPServerConnect();  //ä¸€ç›´è®¿é—®ç›´è‡³è¿æ¥
					MessageBox.Show(ex.Message, "è¿æ¥æœåŠ¡å™¨å¤±è´¥");
				}
				IsOpen = false;
				TCPClient.Dispose();
				BtnConnect.Text = "æ‰“å¼€è¿æ¥";
				Running = false;
			});
		}

		private void TCP_ClientListenning()
		{
			TCPClient.ReceiveTimeout = 2000; //è®¾ç½®è¶…æ—¶æ—¶é—´2s

			///å®¢æˆ·ç«¯æ‰“å¼€
			///è¿æ¥æ­£å¸¸
			while (IsOpen && !(TCPClient.Poll(1000, SelectMode.SelectRead) && TCPClient.Available == 0))
			{
				try
				{
					byte[] newdata = new byte[1024];
					int lenth = TCPClient.Receive(newdata, 1024, SocketFlags.None);
					DataReceived.Invoke(newdata.Take(lenth).ToArray());
					RecByteTemp += lenth;
				}
				catch { }
			}
			if (IsOpen) MessageBox.Show(string.Format("ä¸æœåŠ¡å™¨ {0} çš„è¿æ¥å·²æ–­å¼€", TCPClient.RemoteEndPoint), "è¿æ¥æœåŠ¡å™¨å¼‚å¸¸");
		}

		#endregion

		#region UDP

		private void UDPClientConnect()
		{
			int Port = 0;
			try
			{
				Port = int.Parse(PortBox.Text);
			}
			catch (Exception ex)
			{
				MessageBox.Show(ex.Message, "Portè¾“å…¥é”™è¯¯");
				return;
			}

			IPAddress address;
			try
			{
				address = IPAddress.Parse(RemoteIPComboBox.Text);
			}
			catch (Exception ex)
			{
				MessageBox.Show(ex.Message, "RemoteAddressè¾“å…¥é”™è¯¯");
				return;
			}

			BtnConnect.Text = "è¿æ¥ä¸­";
			Task task = Task.Run(() =>
			{
				try
				{
					UdpClient udpClient = new UdpClient(Port);
					BtnConnect.Text = "æ–­å¼€è¿æ¥";
					IsOpen = true;
					Running = true;
					//å¼€å¯1så®šæ—¶å™¨ æ›´æ–°æ¥æ”¶é€Ÿç‡
					RecSpeedTimerStart();
					//å¼€å¯æ¥æ”¶çº¿ç¨‹
					Task RecTask = Task.Run(() =>
					{
						while (IsOpen)
						{
							try
							{
								IPEndPoint ep = new IPEndPoint(IPAddress.Any, 0);
								byte[] newdata = udpClient.Receive(ref ep);
								DataReceived.Invoke(newdata);
								RecByteTemp += newdata.Length;
							}
							catch { }
						}
					});

					//å¼€å¯æ•°æ®å¤„ç†çº¿ç¨‹
					Task DataHandlerTask = Task.Run(() =>
					{
						while (IsOpen)
						{
							DataHandler?.Invoke(new List<object>
							{
								GetEncoding.Invoke(),
								RecByteSpeed,
								SendBytes,
								(float)0.0F, //æ— ä¸Šé™
                            });
							System.Threading.Thread.Sleep(50); //20fps
						}
					});

					int SleepTime = 1;
					//å‘é€å¾ªç¯
					while (IsOpen)
					{
						try
						{
							if (SendBuffer.DataLenth() > 0)
							{
								try
								{
									Port = int.Parse(PortBox.Text);
								}
								catch (Exception ex)
								{
									MessageBox.Show(ex.Message, "Portè¾“å…¥é”™è¯¯");
									continue;
								}
								byte[] data = SendBuffer.GetDeleteData(-1);
								udpClient.Send(data, data.Length, new IPEndPoint(address, Port));
								SendBytes += data.Length;
								SleepTime = 1;
							}
							else
							{
								System.Threading.Thread.Sleep(SleepTime); //èŠ‚çœCPUèµ„æº
								SleepTime = SleepTime == 100 ? SleepTime : SleepTime++;
							}
						}
						catch (Exception ex)
						{
							MessageBox.Show(ex.Message, "Udp Send");
						}
					}
					udpClient.Close();
				}
				catch (SocketException ex)
				{
					MessageBox.Show(ex.Message, "å¼€å¯UDPå¤±è´¥");
				}
				IsOpen = false;
				BtnConnect.Text = "æ‰“å¼€è¿æ¥";
				Running = false;
			});

		}
		#endregion

		#endregion

		#region å‘é€æ•°æ®æ·»åŠ 

		/// <summary>
		/// æ¸…é™¤å‘é€æ•°æ®ä¸ªæ•°è®°å½•
		/// </summary>
		public void ClearSendBytes()
		{
			SendBytes = 0;
		}

		/// <summary>
		/// æ·»åŠ æ•°æ®åˆ°å‘é€é˜Ÿåˆ—
		/// </summary>
		/// <param name="buff"></param>
		public bool AddSendBuffer(string buff)
		{
			if (IsOpen)
			{
				switch (GetEncoding.Invoke())
				{
					case 0:
						SendBuffer.AddendData(Encoding.ASCII.GetBytes(buff));
						break;
					case 1:
						SendBuffer.AddendData(Encoding.UTF8.GetBytes(buff));
						break;
					case 2:
						SendBuffer.AddendData(Encoding.Unicode.GetBytes(buff));
						break;
				}
				return true;
			}
			return false;
		}

		/// <summary>
		/// æ·»åŠ æ•°æ®åˆ°å‘é€é˜Ÿåˆ—
		/// </summary>
		/// <param name="buff"></param>
		public bool AddSendBuffer(byte[] buff)
		{
			if (IsOpen)
			{
				SendBuffer.AddendData(buff);
				return true;
			}
			return false;
		}

		#endregion


		#region æœ¬åœ°IPåœ°å€è·å–
		private void ThisIPComboBox_DropDown(object sender, EventArgs e)
		{
			try
			{
				UIComboBox box = sender as UIComboBox; //è·å–å½“å‰ä¸‹æ‹‰æ¡†
				string text = box.Text; 
				box.Items.Clear();
				box.Items.Add("Any");
				IPAddress[] IPs = Dns.GetHostEntry(Dns.GetHostName()).AddressList; //è·å–æœ¬æœºæ‰€æœ‰IP
				foreach (IPAddress ip in IPs)
				{
					if (ip.AddressFamily.ToString().Equals("InterNetwork")) box.Items.Add(ip.ToString()); //å¡«å……ä¸‹æ‹‰æ¡†åŠ å…¥æœ¬æœºIP
				}
				box.SelectedItem = text;
			}
			catch (SocketException ex)
			{
				MessageBox.Show(ex.Message);
			}
		}
		#endregion


	}
}
¯OriginalContentÀªSelections‘ƒ¥CaretÀ¥StartÍ
‹£EndÍ¨FilePathÙGD:\Storage\Repo\GPT\TCP_Helper\TCP_Helper\Forms\Setting\Form_Setting.cs¨Language¢C#‘’“¥Value Úif (TXComboBox.Text == "TCP Server")
				{
					TCPServerOpen();
				}
				else if (TXComboBox.Text == "TCP Client")
				{
					TCPClientConnect();
				}
				else if (TXComboBox.Text == "UDP")
				{
					UDPClientConnect();
				}ä¸ºä»€ä¹ˆæ— æ³•è¯†åˆ«åˆ°æ–‡æœ¬è¿›ifÀ¨Response…§ContentÚ,è¿™æ®µä»£ç çš„ç›®çš„æ˜¯æ ¹æ® `TXComboBox` çš„æ–‡æœ¬å€¼æ¥å†³å®šæ‰§è¡Œå“ªä¸ªæ–¹æ³•ã€‚å¦‚æœ `TXComboBox.Text` çš„å€¼æ˜¯ "TCP Server"ï¼Œ"TCP Client" æˆ– "UDP"ï¼Œåˆ™ä¼šåˆ†åˆ«æ‰§è¡Œ `TCPServerOpen()`ï¼Œ`TCPClientConnect()` æˆ– `UDPClientConnect()` æ–¹æ³•ã€‚

å¦‚æœä½ å‘ç°è¿™æ®µä»£ç æ— æ³•è¿›å…¥ä»»ä½•ä¸€ä¸ª `if` æˆ– `else if` è¯­å¥ï¼Œé‚£ä¹ˆå¯èƒ½çš„åŸå› æœ‰ï¼š

1. `TXComboBox.Text` çš„å€¼å¯èƒ½ä¸æ˜¯ "TCP Server"ï¼Œ"TCP Client" æˆ– "UDP"ã€‚ä½ å¯ä»¥é€šè¿‡åœ¨è¿™æ®µä»£ç å‰é¢æ·»åŠ ä¸€è¡Œä»£ç  `Console.WriteLine(TXComboBox.Text);` æ¥æŸ¥çœ‹ `TXComboBox.Text` çš„å®é™…å€¼ã€‚

2. å¦‚æœ `TXComboBox.Text` çš„å€¼ç¡®å®æ˜¯ "TCP Server"ï¼Œ"TCP Client" æˆ– "UDP"ï¼Œä½†æ˜¯ä»ç„¶æ— æ³•è¿›å…¥ç›¸åº”çš„ `if` æˆ– `else if` è¯­å¥ï¼Œé‚£ä¹ˆå¯èƒ½çš„åŸå› æ˜¯ `TXComboBox.Text` çš„å€¼å‰åæœ‰é¢å¤–çš„ç©ºæ ¼ã€‚ä½ å¯ä»¥ä½¿ç”¨ `TXComboBox.Text.Trim()` æ¥ç§»é™¤å‰åçš„ç©ºæ ¼ã€‚

3. å¦‚æœ `TXComboBox` æ˜¯ä¸€ä¸ªç”¨æˆ·ç•Œé¢å…ƒç´ ï¼Œé‚£ä¹ˆå¯èƒ½çš„åŸå› æ˜¯è¿™æ®µä»£ç æ‰§è¡Œæ—¶ç”¨æˆ·ç•Œé¢è¿˜æ²¡æœ‰å®Œå…¨åŠ è½½ï¼Œå› æ­¤ `TXComboBox.Text` çš„å€¼è¿˜æ²¡æœ‰è¢«æ­£ç¡®è®¾ç½®ã€‚ä½ å¯ä»¥å°è¯•åœ¨ç”¨æˆ·ç•Œé¢åŠ è½½å®Œæˆåå†æ‰§è¡Œè¿™æ®µä»£ç ã€‚

4. å¦‚æœä»¥ä¸Šéƒ½ä¸æ˜¯åŸå› ï¼Œé‚£ä¹ˆå¯èƒ½çš„åŸå› æ˜¯ `TXComboBox.Text` çš„å€¼åœ¨æŸä¸ªåœ°æ–¹è¢«æ”¹å˜äº†ã€‚ä½ å¯ä»¥æ£€æŸ¥ä¸€ä¸‹ `TXComboBox.Text` çš„å€¼åœ¨å“ªé‡Œå¯èƒ½è¢«æ”¹å˜ã€‚¤Type ¦Status¯FollowUpPrompts’Ùjæˆ‘åº”è¯¥åœ¨å“ªé‡Œæ·»åŠ  `Console.WriteLine(TXComboBox.Text);` æ¥æŸ¥çœ‹ `TXComboBox.Text` çš„å®é™…å€¼ï¼ŸÙ?æˆ‘å¦‚ä½•åœ¨ç”¨æˆ·ç•Œé¢åŠ è½½å®Œæˆåå†æ‰§è¡Œè¿™æ®µä»£ç ï¼Ÿ³CodeVulnerabilities…¨DateTime×ÿ×²spf×UªThreadNameÀ°CopilotSessionId‚¤GuidÙ$336c22dd-32bb-40e9-b3f7-9c9171323dae¨ClientId¢IdÙ4Microsoft.VisualStudio.Conversations.Chat.HelpWindow§Request§Request•Ù$d487048d-9c76-4646-abb9-2389033510d3Ù$5e0dfd1a-32d3-4e22-8990-0beb338d948e‘†¯ProviderMoniker‚¤NameÙ6Microsoft.VisualStudio.Copilot.DocumentContextProvider§Version£0.1¦Member¤file©CanReduceÃ©RequestIdÙ$d487048d-9c76-4646-abb9-2389033510d3©ReferenceÀ¥ValueÈ:(dÙ‘Microsoft.VisualStudio.Copilot.DocumentContext, Microsoft.VisualStudio.Copilot, Version=0.2.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a…§ContentÚ8öusing System;
using System.Collections;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Net;
using System.Net.Sockets;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using Sunny.UI;

namespace TCP_Helper.Forms.Setting
{
	public partial class Form_Setting : Form
	{
		public string LAN_Mode = string.Empty;  //é€šä¿¡æ–¹å¼
		public Func<int> GetEncoding; //è·å–ç¼–ç æ ¼å¼
		
		public bool IsOpen = false; //å±€åŸŸç½‘æ˜¯å¦å·²ç»å¼€å¯
		public bool Running { get; set; } //æ˜¯å¦æ­£åœ¨è¿è¡Œ åªèƒ½å†…éƒ¨è®¾ç½®ï¼Œä¾›å¤–éƒ¨è¯»å–æ ‡å¿—ä½
		/// <summary>
		/// å‘é€å­—èŠ‚æ•°
		/// </summary>
		private int SendBytes { get; set; }
		/// <summary>
		/// æ¥æ”¶å­—èŠ‚é€Ÿç‡
		/// </summary>
		private int RecByteSpeed { get; set; }
		private int RecByteTemp { get; set; }
		/// <summary>
		/// æ¥æ”¶æ•°æ®å›è°ƒ
		/// </summary>
		public event Action<byte[]> DataReceived;
		/// <summary>
		/// æ•°æ®å¤„ç†
		/// </summary>
		public event Action<List<object>> DataHandler;
		/// <summary>
		/// å‘é€é˜Ÿåˆ—
		/// </summary>
		private readonly DataBuffer SendBuffer = new DataBuffer();
		/// <summary>
		/// ä¸´æ—¶å®¢æˆ·ç«¯ä¿¡æ¯
		/// </summary>
		private Hashtable clientTable = new Hashtable(30);
		public Form_Setting()
		{
			InitializeComponent();
			Running = false;
			TXComboBox.Items.Add("TCP Server");
			TXComboBox.Items.Add("TCP Client");
			TXComboBox.Items.Add("UDP");
		}
		#region comboBoxè¿œç¨‹ç«¯ç‚¹æ›´æ”¹
		private void ComboBox_RemoteIP_Add(EndPoint ep)
		{
			if (RemoteIPComboBox.InvokeRequired)
			{
				Action<EndPoint> action = ComboBox_RemoteIP_Add;
				RemoteIPComboBox.Invoke(action, ep);
			}
			else
			{
				RemoteIPComboBox.Items.Add(ep);
			}
		}

		private void ComboBox_RemoteIP_Delete(EndPoint ep)
		{
			if (RemoteIPComboBox.InvokeRequired)
			{
				Action<EndPoint> action = ComboBox_RemoteIP_Delete;
				RemoteIPComboBox.Invoke(action, ep);
			}
			else
			{
				if (RemoteIPComboBox.Items.Contains(ep))
					RemoteIPComboBox.Items.Remove(ep);
				if (RemoteIPComboBox.Text == ep.ToString())
					RemoteIPComboBox.Text = "";
			}
		}
		#endregion

		#region å¼€å¯å®šæ—¶å™¨ æ¥æ”¶é€Ÿç‡æ›´æ–°
		private void RecSpeedTimerStart()
		{
			System.Threading.Timer timer_1s = null;
			timer_1s = new System.Threading.Timer(timer =>
			{
				if (IsOpen)
				{
					RecByteSpeed = RecByteTemp;
					RecByteTemp = 0;
				}
				else
				{
					timer_1s.Dispose();
				}
			}, timer_1s, 0, 1000);
		}


		#endregion

		#region TCP UDP é€šä¿¡
		private void BtnConnect_Click(object sender, EventArgs e)
		{
			if (BtnConnect.Text == "æ–­å¼€è¿æ¥")
			{
				IsOpen = false;
			}
			else if (BtnConnect.Text == "æ‰“å¼€è¿æ¥")
			{
				if (TXComboBox.Text == "TCP Server")
				{
					TCPServerOpen();
				}
				else if (TXComboBox.Text == "TCP Client")
				{
					TCPClientConnect();
				}
				else if (TXComboBox.Text == "UDP")
				{
					UDPClientConnect();
				}
			}
		}

		#region TCP Server
		private Socket TCPServer;
		public void TCPServerOpen()
		{
			int Port = 0;
			try
			{
				Port = int.Parse(PortBox.Text);
			}
			catch (Exception ex)
			{
				MessageBox.Show(ex.Message, "Portè¾“å…¥é”™è¯¯");
				return;
			}
			BtnConnect.Text = "è¿æ¥ä¸­";
			Task task = Task.Run(() =>
			{
				try
				{
					//åˆå§‹åŒ–SOCKETå®ä¾‹
					TCPServer = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);
					//å…è®¸SOCKETè¢«ç»‘å®šåœ¨å·²ä½¿ç”¨çš„åœ°å€ä¸Šã€‚
					TCPServer.SetSocketOption(SocketOptionLevel.Socket, SocketOptionName.ReuseAddress, true);
					//ç»‘å®šåˆ°æŒ‡å®šIPï¼ŒPortå£ä¸Š
					string LocalAddress = ThisIPComboBox.Text;
					TCPServer.Bind(new IPEndPoint(LocalAddress == "Any" ? IPAddress.Any : IPAddress.Parse(LocalAddress), Port));
					//ç›‘å¬
					TCPServer.Listen(30);
					//å¼€å§‹æ¥å—è¿æ¥ï¼Œå¼‚æ­¥ã€‚
					TCPServer.BeginAccept(new AsyncCallback(OnConnectRequest), TCPServer);
					//æœåŠ¡å™¨å·²å¼€å¯
					BtnConnect.Text = "æ–­å¼€è¿æ¥";
					IsOpen = true;
					Running = true;

					//å¼€å¯1så®šæ—¶å™¨ æ›´æ–°æ¥æ”¶é€Ÿç‡
					RecSpeedTimerStart();

					//å¼€å¯æ•°æ®å¤„ç†çº¿ç¨‹
					Task DataHandlerTask = Task.Run(() =>
					{
						while (IsOpen)
						{
							DataHandler?.Invoke(new List<object>
							{
								GetEncoding.Invoke(),
								RecByteSpeed,
								SendBytes,
								(float)0.0F, //æ— ä¸Šé™
                            });
							System.Threading.Thread.Sleep(50); //20fps
						}
					});

					int SleepTime = 1;
					while (IsOpen)
					{
						if (SendBuffer.DataLenth() > 0 && RemoteIPComboBox.Items.Count > 0)
						{
							byte[] data = SendBuffer.GetDeleteData(-1);
							if (RemoteIPComboBox.SelectedItem != null)
							{
								TCP_Server_Send(data, (EndPoint)RemoteIPComboBox.SelectedItem);
							}
							else
							{
								for (int i = 0; i < RemoteIPComboBox.Items.Count; i++)
								{
									if (i < RemoteIPComboBox.Items.Count)
									{
										EndPoint ep = (EndPoint)RemoteIPComboBox.Items[i];
										TCP_Server_Send(data, (EndPoint)ep);
									}
								}
							}
							SendBytes += data.Length;
							SleepTime = 1;
						}
						else
						{
							System.Threading.Thread.Sleep(SleepTime); //èŠ‚çœCPUèµ„æº
							SleepTime = SleepTime == 100 ? SleepTime : SleepTime++;
						}
					}
				}
				catch (Exception ex)
				{
					MessageBox.Show(ex.Message, "å¼€å¯æœåŠ¡å™¨å¤±è´¥");
				}
				IsOpen = false;
				TCPServer.Close();
				TCPServer.Dispose();
				BtnConnect.Text = "æ‰“å¼€è¿æ¥";
				Running = false;
			});
		}

		private void OnConnectRequest(IAsyncResult ar)
		{
			try
			{
				if (!IsOpen) return;
				///åˆå§‹åŒ–ä¸€ä¸ªSOCKETï¼Œç”¨äºå…¶å®ƒå®¢æˆ·ç«¯çš„è¿æ¥
				Socket client = TCPServer.EndAccept(ar);
				EndPoint remote = client.RemoteEndPoint;
				///è®¾ç½®è¶…æ—¶æ—¶é—´2s
				client.ReceiveTimeout = 2000;
				///å°†å®¢æˆ·ç«¯ç‚¹æ·»åŠ åˆ°å“ˆå¸Œè¡¨ä¸­
				clientTable.Add(remote, client);
				///æ·»åŠ åˆ°comboxç»„ä»¶
				ComboBox_RemoteIP_Add(remote);
				///ç­‰å¾…æ–°çš„å®¢æˆ·ç«¯è¿æ¥
				TCPServer.BeginAccept(new AsyncCallback(OnConnectRequest), TCPServer);

				
				///æœåŠ¡å™¨æœªå…³é—­
				///è¿æ¥æ­£å¸¸
				while (IsOpen && !(client.Poll(1000, SelectMode.SelectRead) && client.Available == 0))
				{
					try
					{
						byte[] newdata = new byte[1024];
						int lenth = client.Receive(newdata);
						DataReceived.Invoke(newdata.Take(lenth).ToArray());
						RecByteTemp += lenth;
					}
					catch { }
				}
				clientTable.Remove(remote);
				ComboBox_RemoteIP_Delete(remote);
				client.Close();
				client.Dispose();
			}
			catch (SocketException ex)
			{
				MessageBox.Show(ex.Message, "å®¢æˆ·ç«¯å¼‚å¸¸");
				//é‡æ–°å¼€å§‹å¼‚æ­¥è¿æ¥
				//TCPServer.BeginAccept(new AsyncCallback(OnConnectRequest), TCPServer);
			}
		}

		/// <summary>
		/// å‘é€
		/// </summary>
		private void TCP_Server_Send(byte[] data, EndPoint ep)
		{
			try
			{
				if (ep != null && clientTable.ContainsKey(ep))
				{
					Socket socket = (Socket)clientTable[ep];
					socket.SendTo(data, ep);
				}
			}
			catch { }
		}
		#endregion

		#region TCP Client

		Socket TCPClient;
		private void TCPClientConnect()
		{
			int Port = 0;
			try
			{
				Port = int.Parse(PortBox.Text);
			}
			catch (Exception ex)
			{
				MessageBox.Show(ex.Message, "Portè¾“å…¥é”™è¯¯");
				return;
			}

			IPAddress address;
			try
			{
				address = IPAddress.Parse(RemoteIPComboBox.Text);
			}
			catch (Exception ex)
			{
				MessageBox.Show(ex.Message, "RemoteAddressè¾“å…¥é”™è¯¯");
				return;
			}

			BtnConnect.Text = "è¿æ¥ä¸­";
			Task connect = Task.Run(() =>
			{
				TCPClient = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);
				try
				{
					TCPClient.Connect(new IPEndPoint(address, Port));
					BtnConnect.Text = "æ–­å¼€è¿æ¥";
					IsOpen = true;
					Running = true;
					//å¼€å¯1så®šæ—¶å™¨ æ›´æ–°æ¥æ”¶é€Ÿç‡
					RecSpeedTimerStart();
					//å¼€å¯æ•°æ®å¤„ç†çº¿ç¨‹
					Task DataHandlerTask = Task.Run(() =>
					{
						while (IsOpen)
						{
							DataHandler?.Invoke(new List<object>
							{
								GetEncoding.Invoke(),
								RecByteSpeed,
								SendBytes,
								(float)0.0F, //æ— ä¸Šé™
                            });
							System.Threading.Thread.Sleep(50); //20fps
						}
					});
					//å¼€å¯å‘é€çº¿ç¨‹
					Task SendTask = Task.Run(() =>
					{
						int SleepTime = 1;
						while (IsOpen)
						{
							try
							{
								if (SendBuffer.DataLenth() > 0)
								{
									byte[] data = SendBuffer.GetDeleteData(-1);
									TCPClient.Send(data);
									SendBytes += data.Length;
									SleepTime = 1;
								}
								else
								{
									System.Threading.Thread.Sleep(SleepTime); //èŠ‚çœCPUèµ„æº
									SleepTime = SleepTime == 100 ? SleepTime : SleepTime++;
								}
							}
							catch { IsOpen = false; }
						}
					});

					TCP_ClientListenning();
				}
				catch (SocketException ex)
				{
					//System.Threading.Thread.Sleep(1000); //1såé‡æ–°è®¿é—®
					//TCPServerConnect();  //ä¸€ç›´è®¿é—®ç›´è‡³è¿æ¥
					MessageBox.Show(ex.Message, "è¿æ¥æœåŠ¡å™¨å¤±è´¥");
				}
				IsOpen = false;
				TCPClient.Dispose();
				BtnConnect.Text = "æ‰“å¼€è¿æ¥";
				Running = false;
			});
		}

		private void TCP_ClientListenning()
		{
			TCPClient.ReceiveTimeout = 2000; //è®¾ç½®è¶…æ—¶æ—¶é—´2s

			///å®¢æˆ·ç«¯æ‰“å¼€
			///è¿æ¥æ­£å¸¸
			while (IsOpen && !(TCPClient.Poll(1000, SelectMode.SelectRead) && TCPClient.Available == 0))
			{
				try
				{
					byte[] newdata = new byte[1024];
					int lenth = TCPClient.Receive(newdata, 1024, SocketFlags.None);
					DataReceived.Invoke(newdata.Take(lenth).ToArray());
					RecByteTemp += lenth;
				}
				catch { }
			}
			if (IsOpen) MessageBox.Show(string.Format("ä¸æœåŠ¡å™¨ {0} çš„è¿æ¥å·²æ–­å¼€", TCPClient.RemoteEndPoint), "è¿æ¥æœåŠ¡å™¨å¼‚å¸¸");
		}

		#endregion

		#region UDP

		private void UDPClientConnect()
		{
			int Port = 0;
			try
			{
				Port = int.Parse(PortBox.Text);
			}
			catch (Exception ex)
			{
				MessageBox.Show(ex.Message, "Portè¾“å…¥é”™è¯¯");
				return;
			}

			IPAddress address;
			try
			{
				address = IPAddress.Parse(RemoteIPComboBox.Text);
			}
			catch (Exception ex)
			{
				MessageBox.Show(ex.Message, "RemoteAddressè¾“å…¥é”™è¯¯");
				return;
			}

			BtnConnect.Text = "è¿æ¥ä¸­";
			Task task = Task.Run(() =>
			{
				try
				{
					UdpClient udpClient = new UdpClient(Port);
					BtnConnect.Text = "æ–­å¼€è¿æ¥";
					IsOpen = true;
					Running = true;
					//å¼€å¯1så®šæ—¶å™¨ æ›´æ–°æ¥æ”¶é€Ÿç‡
					RecSpeedTimerStart();
					//å¼€å¯æ¥æ”¶çº¿ç¨‹
					Task RecTask = Task.Run(() =>
					{
						while (IsOpen)
						{
							try
							{
								IPEndPoint ep = new IPEndPoint(IPAddress.Any, 0);
								byte[] newdata = udpClient.Receive(ref ep);
								DataReceived.Invoke(newdata);
								RecByteTemp += newdata.Length;
							}
							catch { }
						}
					});

					//å¼€å¯æ•°æ®å¤„ç†çº¿ç¨‹
					Task DataHandlerTask = Task.Run(() =>
					{
						while (IsOpen)
						{
							DataHandler?.Invoke(new List<object>
							{
								GetEncoding.Invoke(),
								RecByteSpeed,
								SendBytes,
								(float)0.0F, //æ— ä¸Šé™
                            });
							System.Threading.Thread.Sleep(50); //20fps
						}
					});

					int SleepTime = 1;
					//å‘é€å¾ªç¯
					while (IsOpen)
					{
						try
						{
							if (SendBuffer.DataLenth() > 0)
							{
								try
								{
									Port = int.Parse(PortBox.Text);
								}
								catch (Exception ex)
								{
									MessageBox.Show(ex.Message, "Portè¾“å…¥é”™è¯¯");
									continue;
								}
								byte[] data = SendBuffer.GetDeleteData(-1);
								udpClient.Send(data, data.Length, new IPEndPoint(address, Port));
								SendBytes += data.Length;
								SleepTime = 1;
							}
							else
							{
								System.Threading.Thread.Sleep(SleepTime); //èŠ‚çœCPUèµ„æº
								SleepTime = SleepTime == 100 ? SleepTime : SleepTime++;
							}
						}
						catch (Exception ex)
						{
							MessageBox.Show(ex.Message, "Udp Send");
						}
					}
					udpClient.Close();
				}
				catch (SocketException ex)
				{
					MessageBox.Show(ex.Message, "å¼€å¯UDPå¤±è´¥");
				}
				IsOpen = false;
				BtnConnect.Text = "æ‰“å¼€è¿æ¥";
				Running = false;
			});

		}
		#endregion

		#endregion

		#region å‘é€æ•°æ®æ·»åŠ 

		/// <summary>
		/// æ¸…é™¤å‘é€æ•°æ®ä¸ªæ•°è®°å½•
		/// </summary>
		public void ClearSendBytes()
		{
			SendBytes = 0;
		}

		/// <summary>
		/// æ·»åŠ æ•°æ®åˆ°å‘é€é˜Ÿåˆ—
		/// </summary>
		/// <param name="buff"></param>
		public bool AddSendBuffer(string buff)
		{
			if (IsOpen)
			{
				switch (GetEncoding.Invoke())
				{
					case 0:
						SendBuffer.AddendData(Encoding.ASCII.GetBytes(buff));
						break;
					case 1:
						SendBuffer.AddendData(Encoding.UTF8.GetBytes(buff));
						break;
					case 2:
						SendBuffer.AddendData(Encoding.Unicode.GetBytes(buff));
						break;
				}
				return true;
			}
			return false;
		}

		/// <summary>
		/// æ·»åŠ æ•°æ®åˆ°å‘é€é˜Ÿåˆ—
		/// </summary>
		/// <param name="buff"></param>
		public bool AddSendBuffer(byte[] buff)
		{
			if (IsOpen)
			{
				SendBuffer.AddendData(buff);
				return true;
			}
			return false;
		}

		#endregion


		#region æœ¬åœ°IPåœ°å€è·å–
		private void ThisIPComboBox_DropDown(object sender, EventArgs e)
		{
			try
			{
				UIComboBox box = sender as UIComboBox; //è·å–å½“å‰ä¸‹æ‹‰æ¡†
				string text = box.Text; 
				box.Items.Clear();
				box.Items.Add("Any");
				IPAddress[] IPs = Dns.GetHostEntry(Dns.GetHostName()).AddressList; //è·å–æœ¬æœºæ‰€æœ‰IP
				foreach (IPAddress ip in IPs)
				{
					if (ip.AddressFamily.ToString().Equals("InterNetwork")) box.Items.Add(ip.ToString()); //å¡«å……ä¸‹æ‹‰æ¡†åŠ å…¥æœ¬æœºIP
				}
				box.SelectedItem = text;
			}
			catch (SocketException ex)
			{
				MessageBox.Show(ex.Message);
			}
		}
		#endregion


	}
}
¯OriginalContentÀªSelections‘ƒ¥CaretÀ¥StartÍ
‹£EndÍ¨FilePathÙGD:\Storage\Repo\GPT\TCP_Helper\TCP_Helper\Forms\Setting\Form_Setting.cs¨Language¢C#‘’“¥Value Ùjæˆ‘åº”è¯¥åœ¨å“ªé‡Œæ·»åŠ  `Console.WriteLine(TXComboBox.Text);` æ¥æŸ¥çœ‹ `TXComboBox.Text` çš„å®é™…å€¼ï¼ŸÀ¨Response…§ContentÚRä½ å¯ä»¥åœ¨ `BtnConnect_Click` æ–¹æ³•ä¸­çš„ `if` è¯­å¥ä¹‹å‰æ·»åŠ  `Console.WriteLine(TXComboBox.Text);` æ¥æŸ¥çœ‹ `TXComboBox.Text` çš„å®é™…å€¼ã€‚è¿™æ ·ï¼Œæ¯æ¬¡ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œéƒ½ä¼šåœ¨æ§åˆ¶å°è¾“å‡º `TXComboBox.Text` çš„å€¼ã€‚

è¿™æ˜¯ä¿®æ”¹åçš„ä»£ç ï¼š

```C#
private void BtnConnect_Click(object sender, EventArgs e)
{
    Console.WriteLine(TXComboBox.Text);  // æ·»åŠ è¿™è¡Œä»£ç 

    if (BtnConnect.Text == "æ–­å¼€è¿æ¥")
    {
        IsOpen = false;
    }
    else if (BtnConnect.Text == "æ‰“å¼€è¿æ¥")
    {
        if (TXComboBox.Text == "TCP Server")
        {
            TCPServerOpen();
        }
        else if (TXComboBox.Text == "TCP Client")
        {
            TCPClientConnect();
        }
        else if (TXComboBox.Text == "UDP")
        {
            UDPClientConnect();
        }
    }
}
```

è¯·æ³¨æ„ï¼Œ`Console.WriteLine` çš„è¾“å‡ºä¼šåœ¨ Visual Studio çš„ "Output" çª—å£ä¸­æ˜¾ç¤ºï¼Œè€Œä¸æ˜¯åœ¨ä½ çš„åº”ç”¨ç¨‹åºçš„ç”¨æˆ·ç•Œé¢ä¸­ã€‚å¦‚æœä½ æƒ³åœ¨ç”¨æˆ·ç•Œé¢ä¸­æ˜¾ç¤ºè¿™ä¸ªå€¼ï¼Œä½ å¯èƒ½éœ€è¦ä½¿ç”¨å…¶ä»–æ–¹æ³•ï¼Œä¾‹å¦‚ `MessageBox.Show(TXComboBox.Text);`ã€‚¤Type ¦Status¯FollowUpPrompts’Ù=æˆ‘åº”è¯¥åœ¨å“ªé‡ŒæŸ¥çœ‹ Visual Studio çš„ "Output" çª—å£ï¼ŸÙ=æˆ‘å¦‚ä½•åœ¨ç”¨æˆ·ç•Œé¢ä¸­æ˜¾ç¤º `TXComboBox.Text` çš„å€¼ï¼Ÿ³CodeVulnerabilities